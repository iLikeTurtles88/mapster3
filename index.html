<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
<meta name="description" content="Worldle Arcade 3D - Le d√©fi g√©ographique ultime. Explorez le globe, trouvez les pays et battez le chrono !">
<meta name="theme-color" content="#02040a">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">

<meta property="og:title" content="Worldle Arcade 3D">
<meta property="og:description" content="Testez vos connaissances g√©ographiques sur un globe 3D interactif.">
<meta property="og:image" content="https://unpkg.com/three-globe/example/img/earth-blue-marble.jpg">

<title>Worldle Arcade 3D</title>
    
<!-- Fonts -->
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Outfit:wght@400;500;700;900&display=swap" rel="stylesheet">

<!-- Libraries -->
<script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.9.2/dist/confetti.browser.min.js"></script>
<script src="//unpkg.com/globe.gl"></script>

<style>
    :root {
        --primary: #4cc9f0; 
        --accent: #f72585; 
        --success: #00b894; 
        --warning: #f48c06;
        --bg-glass: rgba(15, 23, 42, 0.85);
        --border-glass: 1px solid rgba(255, 255, 255, 0.15);
        --shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.6);
        --font-main: 'Outfit', sans-serif;
    }
    
    * { box-sizing: border-box; user-select: none; -webkit-tap-highlight-color: transparent; }

    body {
        font-family: var(--font-main);
        background-color: #02040a; color: white;
        margin: 0; overflow: hidden; height: 100vh; width: 100vw;
        position: fixed;
    }

    /* --- LOADING SCREEN --- */
    #loader-overlay {
        position: fixed; top: 0; left: 0; width: 100%; height: 100%;
        background: #02040a; z-index: 9999; display: flex; flex-direction: column;
        justify-content: center; align-items: center; transition: opacity 0.5s;
    }
    .spinner {
        width: 60px; height: 60px; border: 6px solid rgba(255,255,255,0.1);
        border-top-color: var(--primary); border-radius: 50%;
        animation: spin 1s linear infinite; margin-bottom: 25px;
    }
    .loading-text { font-weight: 700; letter-spacing: 3px; text-transform: uppercase; font-size: 1em; animation: pulse 1.5s infinite; color: var(--primary); }

    /* --- SCENE --- */
    #scene-container { position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 1; background: radial-gradient(circle at center, #1a1f35 0%, #000000 100%); }

    /* --- UI LAYOUT --- */
    .hud-layer {
        position: absolute; z-index: 10; pointer-events: none;
        width: 100%; height: 100%; display: flex; flex-direction: column; justify-content: space-between;
        padding: max(15px, env(safe-area-inset-top)) 15px max(15px, env(safe-area-inset-bottom)) 15px;
    }
    .interactive { pointer-events: auto; }

    /* TOP BAR */
    .top-bar { display: flex; justify-content: space-between; align-items: flex-start; }
    
    .player-stats {
        background: var(--bg-glass); backdrop-filter: blur(15px);
        padding: 10px 18px; border-radius: 20px; border: var(--border-glass);
        box-shadow: var(--shadow); display: flex; flex-direction: column; gap: 4px;
        min-width: 150px;
    }
    .level-badge { font-size: 0.75em; color: #94a3b8; font-weight: 800; text-transform: uppercase; letter-spacing: 1px; display: flex; justify-content: space-between; }
    .xp-bar-container { width: 100%; height: 6px; background: rgba(255,255,255,0.1); border-radius: 10px; overflow: hidden; margin-top: 2px; }
    .xp-bar-fill { height: 100%; background: linear-gradient(90deg, var(--primary), var(--accent)); width: 0%; transition: width 0.5s ease; }
    .score-row { display: flex; justify-content: space-between; align-items: baseline; margin-top: 2px; }
    .score-text { font-size: 1.4em; font-weight: 900; line-height: 1; }
    
    .timer-badge { 
        font-family: 'Courier New', monospace; font-size: 1.1em; color: #fff; 
        text-align: right; font-weight: 700; transition: color 0.2s;
    }
    .timer-badge.running { color: var(--warning); text-shadow: 0 0 10px rgba(244, 140, 6, 0.4); }
    .penalty-flash { animation: flashRed 0.6s; color: var(--accent) !important; font-weight: 900; }

    .top-right-actions { display: flex; gap: 10px; align-items: center; }

    .combo-container {
        text-align: right; opacity: 0; transform: scale(0.8); transition: all 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
    }
    .combo-container.active { opacity: 1; transform: scale(1); }
    .combo-val { font-size: 2em; font-weight: 900; color: var(--accent); text-shadow: 0 0 15px rgba(247, 37, 133, 0.6); line-height: 1; }
    .combo-label { font-size: 0.65em; font-weight: 700; color: white; text-transform: uppercase; letter-spacing: 2px; }

    .btn-icon {
        width: 42px; height: 42px; border-radius: 12px; border: var(--border-glass);
        background: var(--bg-glass); color: white; cursor: pointer;
        display: flex; justify-content: center; align-items: center; font-size: 1.2em;
        backdrop-filter: blur(10px); transition: all 0.2s;
    }
    .btn-icon:active { transform: scale(0.9); background: rgba(255,255,255,0.2); }

    /* BOTTOM BAR */
    .bottom-bar {
        display: flex; flex-direction: column; align-items: center; gap: 12px;
        margin-bottom: 10px; transition: transform 0.3s;
    }
    
    .game-input-wrapper {
        position: relative; width: 100%; max-width: 500px;
        background: var(--bg-glass); backdrop-filter: blur(20px);
        border-radius: 24px; padding: 6px 6px 6px 20px; border: var(--border-glass);
        box-shadow: 0 10px 40px rgba(0,0,0,0.6);
        display: flex; gap: 10px; transition: transform 0.2s;
    }
    .game-input-wrapper:focus-within { border-color: var(--primary); box-shadow: 0 0 0 3px rgba(76, 201, 240, 0.2); }
    
    #country-input {
        flex: 1; background: transparent; border: none; color: white;
        font-family: var(--font-main); font-size: 16px; /* Emp√™che zoom iOS */
        font-weight: 600; outline: none; padding: 12px 0;
    }
    #country-input::placeholder { color: rgba(255,255,255,0.3); font-weight: 400; }
    
    .input-actions { display: flex; gap: 5px; }
    .btn-action {
        width: 48px; height: 48px; border-radius: 18px; border: none; cursor: pointer;
        font-size: 1.3em; display: flex; justify-content: center; align-items: center;
        transition: transform 0.2s;
    }
    .btn-action:active { transform: scale(0.9); }
    .btn-hint { background: rgba(244, 140, 6, 0.15); color: var(--warning); border: 1px solid rgba(244, 140, 6, 0.3); }
    
    /* SIDE PANEL */
    .side-panel {
        position: fixed; top: 0; right: 0; height: 100%; width: 300px;
        background: rgba(5, 10, 25, 0.95); backdrop-filter: blur(40px);
        border-left: var(--border-glass); box-shadow: -10px 0 50px rgba(0,0,0,0.8);
        z-index: 50; transform: translateX(105%); transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        padding: max(20px, env(safe-area-inset-top)) 20px 20px 20px; 
        display: flex; flex-direction: column;
    }
    .side-panel.open { transform: translateX(0); }
    
    .panel-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; border-bottom: 1px solid rgba(255,255,255,0.1); padding-bottom: 15px; }
    .panel-title { font-size: 1.2em; font-weight: 700; color: var(--primary); }
    .close-btn { background: none; border: none; color: white; font-size: 1.8em; cursor: pointer; padding: 5px; }
    
    .list-container { overflow-y: auto; flex: 1; padding-right: 5px; }
    
    .list-item {
        display: flex; align-items: center; gap: 15px; padding: 12px;
        background: rgba(255,255,255,0.03); margin-bottom: 8px; border-radius: 12px;
        cursor: pointer; transition: all 0.2s; border: 1px solid transparent;
    }
    .list-item:hover { background: rgba(255,255,255,0.08); border-color: var(--primary); transform: translateX(-5px); }
    .list-flag { width: 36px; height: auto; border-radius: 4px; box-shadow: 0 2px 4px rgba(0,0,0,0.3); }
    .list-name { font-size: 1em; font-weight: 600; }

    /* PROMPT (CLICK MODE) */
    #target-prompt {
        text-align: center; background: var(--bg-glass); padding: 15px 30px;
        border-radius: 50px; backdrop-filter: blur(15px); border: var(--border-glass);
        animation: slideUp 0.5s ease; box-shadow: var(--shadow);
    }
    #target-prompt strong { color: var(--primary); font-size: 1.3em; font-weight: 800; display: block; }

    /* FLOATING TEXT */
    .floater {
        position: absolute; font-weight: 900; font-size: 2em;
        color: var(--success); pointer-events: none; z-index: 100;
        text-shadow: 0 2px 15px rgba(0,0,0,0.8);
        animation: floatUp 1.2s forwards ease-out; white-space: nowrap;
    }

    /* MODALS */
    .modal-backdrop {
        position: fixed; top: 0; left: 0; width: 100%; height: 100%;
        background: rgba(2, 4, 10, 0.9); backdrop-filter: blur(15px);
        z-index: 100; display: flex; justify-content: center; align-items: center;
        opacity: 0; pointer-events: none; transition: opacity 0.3s;
        padding: 20px;
    }
    .modal-backdrop.visible { opacity: 1; pointer-events: auto; }
    
    .game-card {
        background: #1e293b; width: 100%; max-width: 420px;
        border-radius: 30px; padding: 30px; text-align: center;
        border: 1px solid rgba(255,255,255,0.1);
        box-shadow: 0 25px 80px rgba(0,0,0,0.7);
        transform: scale(0.95); transition: transform 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
        position: relative; overflow: hidden;
    }
    .modal-backdrop.visible .game-card { transform: scale(1); }

    .game-card::before {
        content: ''; position: absolute; top: 0; left: 0; width: 100%; height: 6px;
        background: linear-gradient(90deg, var(--primary), var(--accent));
    }

    h2 { margin: 0 0 10px 0; font-size: 2.2em; background: linear-gradient(45deg, #fff, #cbd5e1); -webkit-background-clip: text; -webkit-text-fill-color: transparent; letter-spacing: -1px; }
    .subtitle { color: #94a3b8; margin-bottom: 25px; font-size: 1em; line-height: 1.5; font-weight: 400; }
    
    .btn-main {
        background: linear-gradient(135deg, #4361ee, #4cc9f0);
        border: none; width: 100%; padding: 18px; border-radius: 16px;
        color: white; font-weight: 800; font-size: 1.1em; cursor: pointer;
        margin-top: 15px; box-shadow: 0 10px 25px -5px rgba(67, 97, 238, 0.5);
        transition: transform 0.2s, box-shadow 0.2s; text-transform: uppercase; letter-spacing: 1.5px;
    }
    .btn-main:active:not(:disabled) { transform: scale(0.98); }
    .btn-main:disabled { opacity: 0.6; cursor: not-allowed; filter: grayscale(1); }
    .btn-secondary { background: rgba(255,255,255,0.08); margin-top: 10px; color: #cbd5e1; font-weight: 700; box-shadow: none; }
    .btn-secondary:active { background: rgba(255,255,255,0.12); color: white; }

    /* SETTINGS */
    .settings-grid { display: grid; grid-template-columns: 1fr; gap: 15px; text-align: left; margin: 20px 0; }
    label { font-size: 0.8em; color: #94a3b8; font-weight: 800; text-transform: uppercase; margin-bottom: 8px; display: block; }
    select { 
        width: 100%; padding: 15px; background: #0f172a; border: 1px solid #334155; 
        color: white; border-radius: 14px; font-family: var(--font-main); outline: none;
        font-size: 1em; font-weight: 600; appearance: none;
        background-image: url("data:image/svg+xml;charset=US-ASCII,%3Csvg%20xmlns%3D%22http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%22%20width%3D%22292.4%22%20height%3D%22292.4%22%3E%3Cpath%20fill%3D%22%23FFFFFF%22%20d%3D%22M287%2069.4a17.6%2017.6%200%200%200-13-5.4H18.4c-5%200-9.3%201.8-12.9%205.4A17.6%2017.6%200%200%200%200%2082.2c0%205%201.8%209.3%205.4%2012.9l128%20127.9c3.6%203.6%207.8%205.4%2012.8%205.4s9.2-1.8%2012.8-5.4L287%2095c3.5-3.5%205.4-7.8%205.4-12.8%200-5-1.9-9.2-5.5-12.8z%22%2F%3E%3C%2Fsvg%3E");
        background-repeat: no-repeat; background-position: right 15px top 50%; background-size: 12px auto;
    }

    /* HINTS */
    .hint-grid { display: grid; gap: 10px; margin: 20px 0; }
    .hint-option {
        background: rgba(255,255,255,0.03); border: 1px solid rgba(255,255,255,0.1);
        padding: 16px; border-radius: 16px; cursor: pointer; transition: all 0.2s;
        display: flex; justify-content: space-between; align-items: center;
    }
    .hint-option:active { background: rgba(255,255,255,0.08); border-color: var(--warning); }
    .hint-cost { color: var(--accent); font-weight: 800; font-size: 0.9em; background: rgba(247, 37, 133, 0.1); padding: 5px 10px; border-radius: 8px; }
    
    .revealed-flag { width: 140px; height: auto; border-radius: 10px; margin-top: 15px; box-shadow: 0 4px 15px rgba(0,0,0,0.5); border: 1px solid rgba(255,255,255,0.1); }

    /* ANIMATIONS */
    @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.5; } }
    @keyframes floatUp { 0% { transform: translateY(0) scale(1); opacity: 1; } 100% { transform: translateY(-80px) scale(1.2); opacity: 0; } }
    @keyframes slideUp { from { transform: translateY(30px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
    @keyframes flashRed { 0%, 100% { color: #fff; transform: scale(1); } 50% { color: var(--accent); transform: scale(1.3); } }
    .shake { animation: shake 0.4s cubic-bezier(.36,.07,.19,.97) both; }
    @keyframes shake { 10%, 90% { transform: translate3d(-1px, 0, 0); } 20%, 80% { transform: translate3d(2px, 0, 0); } 30%, 50%, 70% { transform: translate3d(-4px, 0, 0); } 40%, 60% { transform: translate3d(4px, 0, 0); } }

    /* RESPONSIVE */
    @media (max-width: 600px) {
        .player-stats { min-width: auto; padding: 10px 14px; }
        .score-text { font-size: 1.2em; }
        .timer-badge { font-size: 1em; }
        .side-panel { width: 90%; }
        .game-card { width: 100%; padding: 25px 20px; border-radius: 20px; }
        .btn-icon { width: 38px; height: 38px; }
        h2 { font-size: 1.8em; }
        
        /* Gestion Clavier Mobile */
        body.keyboard-open .top-bar { opacity: 0; pointer-events: none; transition: opacity 0.2s; }
        body.keyboard-open #globe-viz { height: 40vh; }
    }
</style>
</head>
<body>

<!-- LOADING SCREEN -->
<div id="loader-overlay">
    <div class="spinner"></div>
    <div class="loading-text">Initialisation...</div>
</div>

<!-- 3D SCENE -->
<div id="scene-container"><div id="globe-viz"></div></div>

<!-- HUD -->
<div class="hud-layer">
    <!-- Top Stats -->
    <div class="top-bar">
        <div class="player-stats">
            <div class="level-badge">
                <span>Niveau <span id="level-val">1</span></span>
                <span id="timer-val" class="timer-badge">00:00</span>
            </div>
            <div class="xp-bar-container"><div class="xp-bar-fill" id="xp-bar"></div></div>
            <div class="score-row">
                <span class="score-text"><span id="score-current">0</span>/<span id="score-total">0</span></span>
            </div>
        </div>
        
        <div class="top-right-actions interactive">
            <div class="combo-container" id="combo-box">
                <div class="combo-val" id="combo-display">x1</div>
                <div class="combo-label">Combo üî•</div>
            </div>
            <button class="btn-icon" id="btn-sound" title="Son On/Off">üîä</button>
            <button class="btn-icon" id="btn-toggle-list" title="Liste des pays">üìã</button>
            <button class="btn-icon" id="btn-reset" title="Menu Principal">üè†</button>
        </div>
    </div>

    <!-- Bottom Controls -->
    <div class="bottom-bar interactive">
        <div id="target-prompt" class="hidden">
            Trouvez : <strong id="target-name">Pays</strong>
        </div>
        
        <div class="game-input-wrapper" id="input-container">
            <input type="text" id="country-input" placeholder="Nom du pays..." autocomplete="off" spellcheck="false" inputmode="text">
            <div class="input-actions">
                <button class="btn-action btn-hint" id="btn-hint" title="Acheter un Indice">üí°</button>
            </div>
        </div>
    </div>
</div>

<!-- SIDE PANEL (LISTE) -->
<div class="side-panel interactive" id="side-panel">
    <div class="panel-header">
        <span class="panel-title">Pays D√©couverts</span>
        <button class="close-btn" id="btn-close-list">√ó</button>
    </div>
    <div class="list-container" id="guessed-list"></div>
</div>

<!-- MENU MODAL -->
<div id="start-modal" class="modal-backdrop visible interactive">
    <div class="game-card">
        <h2>Worldle Arcade</h2>
        <p class="subtitle">Le d√©fi g√©ographique ultime en 3D.<br>Rapidit√©, pr√©cision et exploration.</p>
        
        <div class="settings-grid">
            <div>
                <label>R√©gion</label>
                <select id="opt-region">
                    <option value="World">Monde Entier üåç</option>
                    <option value="Europe">Europe üè∞</option>
                    <option value="Asia">Asie ‚õ©Ô∏è</option>
                    <option value="Africa">Afrique ü¶Å</option>
                    <option value="Americas">Am√©riques üåé</option>
                    <option value="Oceania">Oc√©anie üèùÔ∏è</option>
                </select>
            </div>
            <div>
                <label>Mode de Jeu</label>
                <select id="opt-mode">
                    <option value="type">Saisie (Clavier) ‚å®Ô∏è</option>
                    <option value="click">Localisation (Clic) üñ±Ô∏è</option>
                </select>
            </div>
        </div>

        <button id="btn-start" class="btn-main" disabled>Chargement...</button>
    </div>
</div>

<!-- HINT MODAL -->
<div id="hint-modal" class="modal-backdrop interactive">
    <div class="game-card">
        <h2>Centre d'Indices</h2>
        <p class="subtitle">√âchangez du temps contre des infos.</p>
        
        <div class="hint-grid">
            <div class="hint-option" onclick="game.revealHint('capital')">
                <span>üèôÔ∏è Capitale</span>
                <span class="hint-cost">+20s</span>
            </div>
            <div class="hint-option" onclick="game.revealHint('flag')">
                <span>üè≥Ô∏è Drapeau</span>
                <span class="hint-cost">+20s</span>
            </div>
            <div class="hint-option" onclick="game.revealHint('both')">
                <span>‚ú® Les Deux</span>
                <span class="hint-cost">+40s</span>
            </div>
        </div>
        
        <button onclick="document.getElementById('hint-modal').classList.remove('visible')" class="btn-main btn-secondary">Annuler</button>
    </div>
</div>

<!-- REVEAL MODAL -->
<div id="hint-reveal-modal" class="modal-backdrop interactive">
    <div class="game-card">
        <h2 style="color:var(--warning); -webkit-text-fill-color: var(--warning);">Renseignement</h2>
        <div id="hint-content" style="background:rgba(255,255,255,0.05); padding:20px; border-radius:16px; border:1px solid rgba(255,255,255,0.1); margin: 20px 0;">
            <!-- Content -->
        </div>
        <button onclick="document.getElementById('hint-reveal-modal').classList.remove('visible')" class="btn-main">Compris !</button>
    </div>
</div>

<!-- VICTORY MODAL -->
<div id="end-modal" class="modal-backdrop interactive">
    <div class="game-card">
        <h2 id="end-title">Mission Accomplie</h2>
        <div style="font-size:4.5em; margin:10px 0;">üèÜ</div>
        <p style="font-size:1.1em; color: #cbd5e1;">Tous les pays ont √©t√© localis√©s.</p>
        
        <div style="margin: 25px 0; background:rgba(255,255,255,0.05); padding:20px; border-radius:16px; display:grid; grid-template-columns: 1fr 1fr; gap:10px;">
            <div>
                <div style="font-size:0.8em; color:#94a3b8; text-transform:uppercase;">Temps</div>
                <div id="end-time-final" style="font-size:1.5em; font-weight:900; color:white; font-family:monospace;">00:00</div>
            </div>
            <div>
                <div style="font-size:0.8em; color:#94a3b8; text-transform:uppercase;">XP</div>
                <div id="end-xp" style="font-size:1.5em; font-weight:900; color:var(--success);">+0</div>
            </div>
        </div>

        <button id="btn-share" class="btn-main" style="background:#334155; margin-bottom:10px;">Partager Score üìã</button>
        <button id="btn-replay" class="btn-main">Rejouer</button>
    </div>
</div>

<script>
/**
 * WORLDLE ARCADE 3D - FINAL RELEASE
 */

// --- CONFIGURATION ---
const API_GEO = 'https://cdn.jsdelivr.net/gh/johan/world.geo.json@master/countries.geo.json';
const API_META = 'https://restcountries.com/v3.1/all?fields=cca3,name,translations,capital,region,latlng,population,flags';

// --- ALIASES & MAPPING ---
// Permet de trouver les pays avec des noms alternatifs ou abr√©viations
const ALIASES = {
    'rdc': 'COD',
    'congo': 'COG', // Ou COD selon contexte, ici priorise R√©p du Congo
    'republique democratique du congo': 'COD',
    'usa': 'USA',
    'etats unis': 'USA',
    'etats unis damerique': 'USA',
    'uk': 'GBR',
    'angleterre': 'GBR',
    'grande bretagne': 'GBR',
    'royaume uni': 'GBR',
    'uae': 'ARE',
    'emirats': 'ARE',
    'emirats arabes unis': 'ARE',
    'rsa': 'ZAF',
    'afrique du sud': 'ZAF',
    'hollande': 'NLD',
    'pays bas': 'NLD',
    'russie': 'RUS',
    'chine': 'CHN'
};

// --- STATE ---
const state = {
    data: [],
    activeGame: { 
        running: false, 
        region: 'World', 
        mode: 'type', 
        subset: [], 
        found: new Set(), 
        target: null, 
        timer: 0, 
        timerActive: false 
    },
    stats: { xp: 0, level: 1, combo: 1, lastGuess: 0 },
    settings: { sound: true },
    interval: null
};

// --- DOM ELEMENTS ---
const $ = (id) => document.getElementById(id);
const els = {
    loader: $('loader-overlay'),
    globe: $('globe-viz'),
    input: $('country-input'),
    score: $('score-current'),
    total: $('score-total'),
    timer: $('timer-val'),
    xpBar: $('xp-bar'),
    level: $('level-val'),
    combo: { box: $('combo-box'), val: $('combo-display') },
    prompt: { box: $('target-prompt'), name: $('target-name') },
    modals: { start: $('start-modal'), end: $('end-modal'), hint: $('hint-modal'), reveal: $('hint-reveal-modal') },
    panels: { list: $('side-panel'), listContent: $('guessed-list') },
    btns: { start: $('btn-start'), replay: $('btn-replay'), reset: $('btn-reset'), list: $('btn-toggle-list'), closeList: $('btn-close-list'), hint: $('btn-hint'), sound: $('btn-sound'), share: $('btn-share') },
    hintContent: $('hint-content')
};

let globe, audioCtx;

// --- AUDIO MANAGER ---
const AudioMgr = {
    init: () => { if(!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)(); },
    resume: () => { if(audioCtx && audioCtx.state === 'suspended') audioCtx.resume(); },
    play: (type) => {
        if (!state.settings.sound) return;
        AudioMgr.init(); AudioMgr.resume();
        const t = audioCtx.currentTime;
        const osc = audioCtx.createOscillator();
        const gain = audioCtx.createGain();
        osc.connect(gain); gain.connect(audioCtx.destination);

        if (type === 'correct') {
            playTone(440, 'sine', 0, 0.1); playTone(554.37, 'sine', 0.05, 0.15); playTone(659.25, 'sine', 0.1, 0.2);
        } else if (type === 'wrong') {
            osc.type = 'sawtooth'; osc.frequency.setValueAtTime(150, t); osc.frequency.linearRampToValueAtTime(50, t+0.3);
            gain.gain.setValueAtTime(0.1, t); gain.gain.exponentialRampToValueAtTime(0.01, t+0.3);
            osc.start(t); osc.stop(t+0.3);
        } else if (type === 'levelup') {
            playTone(440, 'square', 0, 0.4); playTone(880, 'square', 0.1, 0.4); playTone(1760, 'square', 0.2, 0.6);
        } else if (type === 'penalty') {
            osc.type = 'triangle'; osc.frequency.setValueAtTime(200, t); osc.frequency.linearRampToValueAtTime(100, t+0.5);
            gain.gain.setValueAtTime(0.2, t); gain.gain.linearRampToValueAtTime(0, t+0.5);
            osc.start(t); osc.stop(t+0.5);
        }
    },
    toggle: () => {
        state.settings.sound = !state.settings.sound;
        els.btns.sound.innerText = state.settings.sound ? "üîä" : "üîá";
        els.btns.sound.style.opacity = state.settings.sound ? 1 : 0.5;
    }
};

function playTone(f, type, delay, dur) {
    const osc = audioCtx.createOscillator(); const g = audioCtx.createGain();
    osc.connect(g); g.connect(audioCtx.destination);
    osc.type = type; osc.frequency.value = f;
    const t = audioCtx.currentTime + delay;
    g.gain.setValueAtTime(0, t); g.gain.linearRampToValueAtTime(0.1, t+0.05); g.gain.exponentialRampToValueAtTime(0.001, t+dur);
    osc.start(t); osc.stop(t+dur);
}

// --- INITIALIZATION ---
async function initApp() {
    try {
        const [geoRes, metaRes] = await Promise.all([ fetch(API_GEO), fetch(API_META) ]);
        if(!geoRes.ok || !metaRes.ok) throw new Error("API Error");

        const geo = await geoRes.json();
        const meta = await metaRes.json();

        // MERGE DATA
        state.data = geo.features.map(f => {
            // Mapping strict par code ISO
            const m = meta.find(c => c.cca3 === f.id);
            if (!m) return null; // Ignore polygons without data
            return {
                id: f.id,
                geo: f,
                name: m.name.common,
                fr: m.translations.fra?.common || m.name.common,
                region: m.region,
                capital: m.capital ? m.capital[0] : 'N/A',
                coords: { lat: m.latlng[0], lng: m.latlng[1] },
                flag: m.flags.svg
            };
        }).filter(x => x);

        loadSave();
        initGlobe();
        
        els.loader.style.opacity = 0;
        setTimeout(() => els.loader.style.display = 'none', 500);
        els.btns.start.textContent = "Lancer l'Aventure";
        els.btns.start.disabled = false;

    } catch (e) {
        console.error(e);
        els.loader.innerHTML = "<div style='color:var(--accent); text-align:center'>Erreur r√©seau.<br>Rafra√Æchir la page.</div>";
    }
}

function initGlobe() {
    globe = Globe()
        .backgroundColor('rgba(0,0,0,0)')
        .showAtmosphere(true)
        .atmosphereColor('#4cc9f0')
        .atmosphereAltitude(0.15)
        .globeImageUrl('//unpkg.com/three-globe/example/img/earth-blue-marble.jpg')
        .bumpImageUrl('//unpkg.com/three-globe/example/img/earth-topology.png')
        .polygonsData(state.data.map(c => ({ ...c.geo, data: c })))
        
        // --- Z-FIGHTING FIX (IMPORTANT) ---
        .polygonAltitude(0.02) 
        .polygonSideColor(() => 'rgba(0,0,0,0)')
        .polygonStrokeColor(() => 'rgba(255, 255, 255, 0.2)')
        .polygonCapColor(() => 'rgba(30, 41, 59, 0.6)')
        
        .onPolygonClick(handleInput.click)
        .onPolygonHover(d => els.globe.style.cursor = d ? 'pointer' : 'grab')
        .polygonLabel(({ data }) => `
            <div style="background:rgba(15,23,42,0.95); color:white; padding:6px 10px; border-radius:6px; font-family:sans-serif; border:1px solid rgba(255,255,255,0.2); font-size:14px; font-weight:600;">
                ${data.fr}
            </div>
        `)
        (els.globe);

    globe.controls().autoRotate = true;
    globe.controls().autoRotateSpeed = 0.5;
    globe.pointOfView({ altitude: 2.5 });
    
    new ResizeObserver(() => {
        globe.width(els.globe.clientWidth);
        globe.height(els.globe.clientHeight);
    }).observe($('scene-container'));
}

// --- GAME LOGIC ---
const game = {
    start: () => {
        AudioMgr.resume();
        const r = $('opt-region').value;
        const m = $('opt-mode').value;
        
        state.activeGame = {
            running: true,
            region: r,
            mode: m,
            subset: r === 'World' ? state.data : state.data.filter(c => c.region === r),
            found: new Set(),
            target: null,
            timer: 0,
            timerActive: false
        };

        if(state.activeGame.subset.length === 0) return alert("Erreur donn√©es r√©gion.");

        // Reset
        state.stats.combo = 1;
        els.score.innerText = 0;
        els.total.innerText = state.activeGame.subset.length;
        els.timer.innerText = "00:00";
        els.timer.classList.remove('running');
        els.panels.listContent.innerHTML = '';
        els.combo.box.classList.remove('active');
        
        els.modals.start.classList.remove('visible');
        els.modals.end.classList.remove('visible');
        
        els.input.value = '';
        if (m === 'click') {
            $('input-container').style.display = 'none';
            els.prompt.box.classList.remove('hidden');
            game.nextTarget();
        } else {
            $('input-container').style.display = 'flex';
            els.prompt.box.classList.add('hidden');
            els.input.focus();
            globe.polygonLabel(null);
        }

        globe.controls().autoRotate = false;
        
        const first = state.activeGame.subset[0];
        globe.pointOfView({ lat: first.coords.lat, lng: first.coords.lng, altitude: 2 }, 1000);
        
        game.updateVisuals();
    },

    checkTimer: () => {
        if(!state.activeGame.timerActive) {
            state.activeGame.timerActive = true;
            els.timer.classList.add('running');
            state.interval = setInterval(() => {
                state.activeGame.timer++;
                game.renderTimer();
            }, 1000);
        }
    },

    stop: () => {
        state.activeGame.running = false;
        state.activeGame.timerActive = false;
        clearInterval(state.interval);
        els.timer.classList.remove('running');
    },

    renderTimer: () => {
        const m = Math.floor(state.activeGame.timer / 60).toString().padStart(2, '0');
        const s = (state.activeGame.timer % 60).toString().padStart(2, '0');
        els.timer.innerText = `${m}:${s}`;
    },

    penalty: (sec) => {
        game.checkTimer();
        state.activeGame.timer += sec;
        game.renderTimer();
        AudioMgr.play('penalty');
        ui.floatText(`+${sec}s`, window.innerWidth/2, window.innerHeight/2, 'var(--accent)');
        els.timer.classList.add('penalty-flash');
        setTimeout(() => els.timer.classList.remove('penalty-flash'), 600);
    },

    success: (country) => {
        game.checkTimer();
        state.activeGame.found.add(country.id);

        const now = Date.now();
        if (now - state.stats.lastGuess < 7000) state.stats.combo++;
        else state.stats.combo = 1;
        state.stats.lastGuess = now;

        AudioMgr.play('correct');
        confetti({ particleCount: 80, spread: 60, origin: { y: 0.6 }, colors: ['#4cc9f0', '#f72585'] });
        ui.floatText(`+${10 * state.stats.combo} XP`, window.innerWidth/2, window.innerHeight/2);
        ui.gainXP(10 * state.stats.combo);

        els.score.innerText = state.activeGame.found.size;
        ui.updateCombo();
        game.updateVisuals();
        ui.addToList(country);

        globe.pointOfView({ lat: country.coords.lat, lng: country.coords.lng, altitude: 1.5 }, 1000);

        if (state.activeGame.found.size === state.activeGame.subset.length) game.win();
    },

    fail: () => {
        state.stats.combo = 1;
        ui.updateCombo();
        AudioMgr.play('wrong');
        document.body.classList.add('shake');
        setTimeout(() => document.body.classList.remove('shake'), 400);
    },

    nextTarget: () => {
        const remaining = state.activeGame.subset.filter(c => !state.activeGame.found.has(c.id));
        if(remaining.length === 0) return game.win();
        state.activeGame.target = remaining[Math.floor(Math.random() * remaining.length)];
        els.prompt.name.innerText = state.activeGame.target.fr;
    },

    updateVisuals: () => {
        globe.polygonCapColor(({ data }) => {
            if (state.activeGame.found.has(data.id)) return '#4cc9f0';
            if (!state.activeGame.running) return 'rgba(30, 41, 59, 0.6)';
            
            // Highlight region to help player
            if (state.activeGame.subset.find(c => c.id === data.id)) return 'rgba(255, 255, 255, 0.1)';
            return 'rgba(30, 41, 59, 0.6)';
        });
        const d = globe.polygonsData(); globe.polygonsData([...d]);
    },

    revealHint: (type) => {
        if (!state.activeGame.running) return;
        const remaining = state.activeGame.subset.filter(c => !state.activeGame.found.has(c.id));
        if (remaining.length === 0) return;

        const target = state.activeGame.mode === 'click' 
            ? state.activeGame.target 
            : remaining[Math.floor(Math.random() * remaining.length)];

        let cost = 20;
        let html = '';

        if (type === 'capital') {
            html = `<strong>üèôÔ∏è Capitale :</strong> <span style="color:var(--primary); font-size:1.4em;">${target.capital}</span>`;
        } else if (type === 'flag') {
            html = `<strong>üè≥Ô∏è Drapeau :</strong><br><img src="${target.flag}" class="revealed-flag">`;
        } else {
            cost = 40;
            html = `<strong>üèôÔ∏è Capitale :</strong> ${target.capital}<br><strong>üè≥Ô∏è Drapeau :</strong><br><img src="${target.flag}" class="revealed-flag">`;
        }

        game.penalty(cost);
        els.modals.hint.classList.remove('visible');
        els.hintContent.innerHTML = html;
        els.modals.reveal.classList.add('visible');
        globe.pointOfView({ lat: target.coords.lat, lng: target.coords.lng, altitude: 2.2 }, 1200);
    },

    win: () => {
        game.stop();
        els.modals.end.classList.add('visible');
        $('end-xp').innerText = `+${state.activeGame.found.size * 10}`;
        $('end-time-final').innerText = els.timer.innerText;
        globe.controls().autoRotate = true;
    }
};

// --- INPUT HANDLING ---
const handleInput = {
    type: () => {
        if (!state.activeGame.running || state.activeGame.mode !== 'type') return;
        const val = normalize(els.input.value);
        
        // 1. Check Aliases
        let matchedID = ALIASES[val];
        
        // 2. Check Name Matching
        let match = null;
        if (matchedID) {
            match = state.activeGame.subset.find(c => c.id === matchedID && !state.activeGame.found.has(c.id));
        } else {
            match = state.activeGame.subset.find(c => 
                !state.activeGame.found.has(c.id) && normalize(c.fr) === val
            );
        }

        if (match) { 
            game.success(match); 
            els.input.value = ''; 
        }
    },
    click: (polygon) => {
        if (!state.activeGame.running) return;
        const c = polygon.data;
        if (state.activeGame.mode === 'click') {
            if (c.id === state.activeGame.target.id) {
                game.success(c);
                game.nextTarget();
            } else {
                game.fail();
                game.penalty(20); // P√âNALIT√â APPLIQU√âE
            }
        }
    }
};

// --- UI HELPERS ---
const ui = {
    gainXP: (amount) => {
        state.stats.xp += amount;
        const needed = state.stats.level * 100;
        if(state.stats.xp >= needed) {
            state.stats.level++;
            state.stats.xp -= needed;
            AudioMgr.play('levelup');
            ui.floatText("NIVEAU SUP√âRIEUR !", window.innerWidth/2, window.innerHeight/3, 'var(--accent)');
        }
        saveGame(); ui.renderStats();
    },
    renderStats: () => {
        els.level.innerText = state.stats.level;
        els.xpBar.style.width = `${(state.stats.xp / (state.stats.level * 100)) * 100}%`;
    },
    updateCombo: () => {
        if (state.stats.combo > 1) {
            els.combo.box.classList.add('active');
            els.combo.val.innerText = `x${state.stats.combo}`;
            els.combo.val.style.transform = 'scale(1.5)';
            setTimeout(() => els.combo.val.style.transform = 'scale(1)', 200);
        } else {
            els.combo.box.classList.remove('active');
        }
    },
    addToList: (c) => {
        const div = document.createElement('div'); div.className = 'list-item';
        div.innerHTML = `<img src="${c.flag}" class="list-flag" loading="lazy"><span class="list-name">${c.fr}</span>`;
        div.onclick = () => { 
            globe.pointOfView({ lat: c.coords.lat, lng: c.coords.lng, altitude: 1.2 }, 1000); 
            if (window.innerWidth < 600) els.panels.list.classList.remove('open');
        };
        els.panels.listContent.prepend(div);
    },
    floatText: (text, x, y, color) => {
        const el = document.createElement('div'); el.className = 'floater'; 
        el.innerText = text; el.style.left = `${x}px`; el.style.top = `${y}px`;
        if(color) el.style.color = color;
        document.body.appendChild(el);
        setTimeout(() => el.remove(), 1200);
    }
};

// --- UTILS ---
function normalize(s) { return s.normalize("NFD").replace(/[\u0300-\u036f]/g, "").toLowerCase().replace(/[-']/g, " ").trim(); }
function saveGame() { localStorage.setItem('wa_xp', state.stats.xp); localStorage.setItem('wa_lvl', state.stats.level); }
function loadSave() { state.stats.xp = parseInt(localStorage.getItem('wa_xp')) || 0; state.stats.level = parseInt(localStorage.getItem('wa_lvl')) || 1; ui.renderStats(); }

// --- EVENTS ---
els.btns.start.onclick = game.start;
els.btns.replay.onclick = () => { els.modals.end.classList.remove('visible'); els.modals.start.classList.add('visible'); };
els.btns.reset.onclick = () => { if(confirm("Quitter la partie ?")) { game.stop(); els.modals.start.classList.add('visible'); globe.controls().autoRotate = true; } };
els.btns.list.onclick = () => els.panels.list.classList.add('open');
els.btns.closeList.onclick = () => els.panels.list.classList.remove('open');
els.btns.hint.onclick = () => { if(state.activeGame.running) els.modals.hint.classList.add('visible'); };
els.btns.sound.onclick = AudioMgr.toggle;
els.btns.share.onclick = () => {
    const txt = `üåç Worldle Arcade 3D\nüèÜ Niveau ${state.stats.level}\n‚è±Ô∏è ${els.timer.innerText}\n‚úÖ ${state.activeGame.found.size} pays trouv√©s !`;
    navigator.clipboard.writeText(txt).then(() => alert("Score copi√© !"));
};
els.input.oninput = handleInput.type;

// Mobile Logic
if (/iPad|iPhone|iPod/.test(navigator.userAgent)) {
    els.input.addEventListener('focus', () => { document.body.classList.add('keyboard-open'); globe.pointOfView({ lat: globe.pointOfView().lat + 25, altitude: globe.pointOfView().altitude }, 500); });
    els.input.addEventListener('blur', () => document.body.classList.remove('keyboard-open'));
}

initApp();

</script>
</body>
</html>
