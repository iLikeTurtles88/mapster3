<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
<meta name="description" content="Worldle Arcade 3D - Le d√©fi g√©ographique ultime. Explorez le globe, trouvez les pays et battez le chrono !">
<meta name="theme-color" content="#02040a">
<meta property="og:title" content="Worldle Arcade 3D">
<meta property="og:description" content="Testez vos connaissances g√©ographiques sur un globe 3D interactif.">
<meta property="og:image" content="https://unpkg.com/three-globe/example/img/earth-blue-marble.jpg">

<title>Worldle Arcade 3D - Edition Finale</title>
    
<!-- Fonts & Icons -->
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Outfit:wght@400;500;700;900&display=swap" rel="stylesheet">

<!-- Libraries -->
<script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.9.2/dist/confetti.browser.min.js"></script>
<script src="//unpkg.com/globe.gl"></script>

<style>
    :root {
        --primary: #4cc9f0; 
        --accent: #f72585; 
        --success: #4cc9f0; 
        --warning: #f48c06;
        --bg-glass: rgba(15, 23, 42, 0.8);
        --border-glass: 1px solid rgba(255, 255, 255, 0.15);
        --shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.5);
        --font-main: 'Outfit', sans-serif;
    }
    
    * { box-sizing: border-box; user-select: none; -webkit-tap-highlight-color: transparent; }

    body {
        font-family: var(--font-main);
        background-color: #02040a; color: white;
        margin: 0; overflow: hidden; height: 100vh; width: 100vw;
        position: fixed; /* Prevent rubber-banding on mobile */
    }

    /* --- LOADING SCREEN --- */
    #loader-overlay {
        position: fixed; top: 0; left: 0; width: 100%; height: 100%;
        background: #02040a; z-index: 9999; display: flex; flex-direction: column;
        justify-content: center; align-items: center; transition: opacity 0.5s;
    }
    .spinner {
        width: 50px; height: 50px; border: 5px solid rgba(255,255,255,0.1);
        border-top-color: var(--primary); border-radius: 50%;
        animation: spin 1s linear infinite; margin-bottom: 20px;
    }
    .loading-text { font-weight: 600; letter-spacing: 2px; text-transform: uppercase; font-size: 0.9em; animation: pulse 1.5s infinite; }

    /* --- SCENE --- */
    #scene-container { position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 1; background: radial-gradient(circle at center, #1a1f35 0%, #02040a 100%); }

    /* --- UI LAYOUT --- */
    .hud-layer {
        position: absolute; z-index: 10; pointer-events: none;
        width: 100%; height: 100%; display: flex; flex-direction: column; justify-content: space-between;
        padding: max(20px, env(safe-area-inset-top)) 20px max(20px, env(safe-area-inset-bottom)) 20px;
    }
    .interactive { pointer-events: auto; }

    /* TOP BAR */
    .top-bar { display: flex; justify-content: space-between; align-items: flex-start; }
    
    .player-stats {
        background: var(--bg-glass); backdrop-filter: blur(12px);
        padding: 12px 20px; border-radius: 18px; border: var(--border-glass);
        box-shadow: var(--shadow); display: flex; flex-direction: column; gap: 6px;
        min-width: 160px;
    }
    .level-badge { font-size: 0.75em; color: #cbd5e1; font-weight: 700; text-transform: uppercase; letter-spacing: 1px; display: flex; justify-content: space-between; }
    .xp-bar-container { width: 100%; height: 6px; background: rgba(255,255,255,0.1); border-radius: 10px; overflow: hidden; margin-top: 2px; }
    .xp-bar-fill { height: 100%; background: linear-gradient(90deg, var(--primary), var(--accent)); width: 0%; transition: width 0.5s ease; }
    .score-row { display: flex; justify-content: space-between; align-items: flex-end; }
    .score-text { font-size: 1.6em; font-weight: 900; line-height: 1; }
    
    .timer-badge { 
        font-family: monospace; font-size: 1.2em; color: #fff; 
        text-align: right; font-weight: 700; transition: color 0.2s;
    }
    .timer-badge.running { color: var(--warning); }
    .penalty-flash { animation: flashRed 0.5s; color: var(--accent) !important; }

    .top-right-actions { display: flex; gap: 12px; align-items: center; }

    .combo-container {
        text-align: right; opacity: 0; transform: scale(0.8); transition: all 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
    }
    .combo-container.active { opacity: 1; transform: scale(1); }
    .combo-val { font-size: 2.2em; font-weight: 900; color: var(--accent); text-shadow: 0 0 20px rgba(247, 37, 133, 0.5); line-height: 1; }
    .combo-label { font-size: 0.7em; font-weight: 700; color: white; text-transform: uppercase; letter-spacing: 2px; }

    .btn-icon {
        width: 44px; height: 44px; border-radius: 14px; border: var(--border-glass);
        background: var(--bg-glass); color: white; cursor: pointer;
        display: flex; justify-content: center; align-items: center; font-size: 1.2em;
        backdrop-filter: blur(5px); transition: all 0.2s;
    }
    .btn-icon:hover { background: rgba(255,255,255,0.2); transform: scale(1.05); }
    .btn-icon:active { transform: scale(0.95); }

    /* BOTTOM BAR */
    .bottom-bar {
        display: flex; flex-direction: column; align-items: center; gap: 15px;
        margin-bottom: 10px; transition: transform 0.3s;
    }
    
    .game-input-wrapper {
        position: relative; width: 100%; max-width: 500px;
        background: var(--bg-glass); backdrop-filter: blur(16px);
        border-radius: 20px; padding: 8px 8px 8px 20px; border: var(--border-glass);
        box-shadow: 0 10px 40px rgba(0,0,0,0.6);
        display: flex; gap: 10px; transition: transform 0.2s;
    }
    .game-input-wrapper:focus-within { border-color: var(--primary); box-shadow: 0 0 0 2px rgba(76, 201, 240, 0.3); }
    
    #country-input {
        flex: 1; background: transparent; border: none; color: white;
        font-family: var(--font-main); font-size: 1.1em; font-weight: 500;
        outline: none; padding: 10px 0;
    }
    #country-input::placeholder { color: rgba(255,255,255,0.4); }
    
    .input-actions { display: flex; gap: 5px; }
    .btn-action {
        width: 45px; height: 45px; border-radius: 14px; border: none; cursor: pointer;
        font-size: 1.2em; display: flex; justify-content: center; align-items: center;
        transition: transform 0.2s;
    }
    .btn-action:hover { transform: scale(1.05); }
    .btn-action:active { transform: scale(0.95); }
    .btn-hint { background: rgba(244, 140, 6, 0.2); color: var(--warning); }
    .btn-hint:hover { background: rgba(244, 140, 6, 0.4); }
    
    /* SIDE PANEL */
    .side-panel {
        position: fixed; top: 0; right: 0; height: 100%; width: 320px;
        background: rgba(10, 15, 30, 0.98); backdrop-filter: blur(30px);
        border-left: var(--border-glass); box-shadow: -10px 0 50px rgba(0,0,0,0.8);
        z-index: 50; transform: translateX(105%); transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        padding: max(20px, env(safe-area-inset-top)) 20px 20px 20px; 
        display: flex; flex-direction: column;
    }
    .side-panel.open { transform: translateX(0); }
    
    .panel-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; border-bottom: 1px solid rgba(255,255,255,0.1); padding-bottom: 15px; }
    .panel-title { font-size: 1.2em; font-weight: 700; color: var(--primary); }
    .close-btn { background: none; border: none; color: white; font-size: 1.8em; cursor: pointer; padding: 5px; }
    
    .list-container { overflow-y: auto; flex: 1; padding-right: 5px; }
    .list-container::-webkit-scrollbar { width: 4px; }
    .list-container::-webkit-scrollbar-thumb { background: rgba(255,255,255,0.2); border-radius: 4px; }
    
    .list-item {
        display: flex; align-items: center; gap: 15px; padding: 12px;
        background: rgba(255,255,255,0.03); margin-bottom: 8px; border-radius: 10px;
        cursor: pointer; transition: all 0.2s; border: 1px solid transparent;
    }
    .list-item:hover { background: rgba(255,255,255,0.08); border-color: var(--primary); transform: translateX(-2px); }
    .list-flag { width: 32px; height: 24px; border-radius: 4px; object-fit: cover; box-shadow: 0 2px 4px rgba(0,0,0,0.3); }
    .list-name { font-size: 0.95em; font-weight: 600; }

    /* PROMPT (CLICK MODE) */
    #target-prompt {
        text-align: center; background: var(--bg-glass); padding: 12px 25px;
        border-radius: 50px; backdrop-filter: blur(10px); border: var(--border-glass);
        animation: slideUp 0.5s ease; box-shadow: var(--shadow);
    }
    #target-prompt strong { color: var(--primary); font-size: 1.2em; font-weight: 800; }

    /* FLOATING TEXT */
    .floater {
        position: absolute; font-weight: 900; font-size: 1.8em;
        color: var(--success); pointer-events: none; z-index: 20;
        text-shadow: 0 2px 15px rgba(0,0,0,0.8);
        animation: floatUp 1.2s forwards ease-out;
    }

    /* MODALS */
    .modal-backdrop {
        position: fixed; top: 0; left: 0; width: 100%; height: 100%;
        background: rgba(2, 4, 10, 0.85); backdrop-filter: blur(15px);
        z-index: 100; display: flex; justify-content: center; align-items: center;
        opacity: 0; pointer-events: none; transition: opacity 0.3s;
    }
    .modal-backdrop.visible { opacity: 1; pointer-events: auto; }
    
    .game-card {
        background: #1e293b; width: 90%; max-width: 420px;
        border-radius: 24px; padding: 30px; text-align: center;
        border: 1px solid rgba(255,255,255,0.1);
        box-shadow: 0 20px 60px rgba(0,0,0,0.6);
        transform: scale(0.9); transition: transform 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
        position: relative; overflow: hidden;
    }
    .modal-backdrop.visible .game-card { transform: scale(1); }

    /* CARD DECORATION */
    .game-card::before {
        content: ''; position: absolute; top: 0; left: 0; width: 100%; height: 5px;
        background: linear-gradient(90deg, var(--primary), var(--accent));
    }

    h2 { margin: 0 0 10px 0; font-size: 2.2em; background: linear-gradient(45deg, #fff, #cbd5e1); -webkit-background-clip: text; -webkit-text-fill-color: transparent; letter-spacing: -1px; }
    .subtitle { color: #94a3b8; margin-bottom: 25px; font-size: 0.95em; line-height: 1.5; }
    
    .btn-main {
        background: linear-gradient(135deg, #4361ee, #4cc9f0);
        border: none; width: 100%; padding: 16px; border-radius: 14px;
        color: white; font-weight: 800; font-size: 1.1em; cursor: pointer;
        margin-top: 20px; box-shadow: 0 8px 20px -5px rgba(67, 97, 238, 0.5);
        transition: transform 0.2s, box-shadow 0.2s; text-transform: uppercase; letter-spacing: 1px;
    }
    .btn-main:hover:not(:disabled) { transform: translateY(-2px); box-shadow: 0 12px 25px -5px rgba(67, 97, 238, 0.6); }
    .btn-main:disabled { opacity: 0.6; cursor: not-allowed; filter: grayscale(1); }
    .btn-secondary { background: rgba(255,255,255,0.1); margin-top: 10px; color: #cbd5e1; font-weight: 600; }
    .btn-secondary:hover { background: rgba(255,255,255,0.15); color: white; }

    /* FORM ELEMENTS */
    .settings-grid { display: grid; grid-template-columns: 1fr; gap: 15px; text-align: left; margin: 20px 0; }
    label { font-size: 0.8em; color: #94a3b8; font-weight: 700; text-transform: uppercase; margin-bottom: 6px; display: block; }
    select { 
        width: 100%; padding: 14px; background: #0f172a; border: 1px solid #334155; 
        color: white; border-radius: 12px; font-family: var(--font-main); outline: none;
        font-size: 1em; cursor: pointer; transition: border-color 0.2s;
    }
    select:focus { border-color: var(--primary); }

    /* HINT MODAL */
    .hint-grid { display: grid; gap: 10px; margin: 20px 0; }
    .hint-option {
        background: rgba(255,255,255,0.03); border: 1px solid rgba(255,255,255,0.1);
        padding: 16px; border-radius: 14px; cursor: pointer; transition: all 0.2s;
        display: flex; justify-content: space-between; align-items: center;
    }
    .hint-option:hover { background: rgba(255,255,255,0.08); border-color: var(--warning); transform: translateX(5px); }
    .hint-cost { color: var(--accent); font-weight: 800; font-size: 0.9em; background: rgba(247, 37, 133, 0.1); padding: 4px 8px; border-radius: 6px; }
    
    .revealed-flag { width: 120px; height: auto; border-radius: 8px; margin-top: 15px; box-shadow: 0 4px 15px rgba(0,0,0,0.5); border: 1px solid rgba(255,255,255,0.1); }

    /* ANIMATIONS */
    @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.5; } }
    @keyframes floatUp { 0% { transform: translateY(0) scale(1); opacity: 1; } 100% { transform: translateY(-60px) scale(1.2); opacity: 0; } }
    @keyframes slideUp { from { transform: translateY(20px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
    @keyframes flashRed { 0%, 100% { color: var(--warning); transform: scale(1); } 50% { color: var(--accent); transform: scale(1.2); } }
    .shake { animation: shake 0.4s cubic-bezier(.36,.07,.19,.97) both; }
    @keyframes shake { 10%, 90% { transform: translate3d(-1px, 0, 0); } 20%, 80% { transform: translate3d(2px, 0, 0); } 30%, 50%, 70% { transform: translate3d(-4px, 0, 0); } 40%, 60% { transform: translate3d(4px, 0, 0); } }

    /* RESPONSIVE */
    @media (max-width: 600px) {
        .player-stats { min-width: auto; padding: 10px 15px; }
        .score-text { font-size: 1.3em; }
        .timer-badge { font-size: 1em; }
        .side-panel { width: 85%; }
        .game-card { width: 95%; padding: 20px; }
        
        /* Handle keyboard push on mobile */
        body.keyboard-open .top-bar { opacity: 0; pointer-events: none; }
        body.keyboard-open #globe-viz { height: 40vh; }
    }
</style>
</head>
<body>

<!-- LOADING SCREEN -->
<div id="loader-overlay">
    <div class="spinner"></div>
    <div class="loading-text">Pr√©paration du Globe...</div>
</div>

<!-- 3D SCENE -->
<div id="scene-container"><div id="globe-viz"></div></div>

<!-- HUD -->
<div class="hud-layer">
    <!-- Top Stats -->
    <div class="top-bar">
        <div class="player-stats">
            <div class="level-badge">
                <span>Niveau <span id="level-val">1</span></span>
                <span id="timer-val" class="timer-badge">00:00</span>
            </div>
            <div class="xp-bar-container"><div class="xp-bar-fill" id="xp-bar"></div></div>
            <div class="score-row">
                <span class="score-text"><span id="score-current">0</span>/<span id="score-total">0</span></span>
            </div>
        </div>
        
        <div class="top-right-actions interactive">
            <div class="combo-container" id="combo-box">
                <div class="combo-val" id="combo-display">x1</div>
                <div class="combo-label">Combo üî•</div>
            </div>
            <button class="btn-icon" id="btn-sound" title="Son On/Off">üîä</button>
            <button class="btn-icon" id="btn-toggle-list" title="Liste des pays">üìã</button>
            <button class="btn-icon" id="btn-reset" title="Menu Principal">üè†</button>
        </div>
    </div>

    <!-- Bottom Controls -->
    <div class="bottom-bar interactive">
        <div id="target-prompt" class="hidden">
            Trouvez : <strong id="target-name">Pays</strong>
        </div>
        
        <div class="game-input-wrapper" id="input-container">
            <input type="text" id="country-input" placeholder="Entrez le nom du pays..." autocomplete="off" spellcheck="false">
            <div class="input-actions">
                <button class="btn-action btn-hint" id="btn-hint" title="Acheter un Indice">üí°</button>
            </div>
        </div>
    </div>
</div>

<!-- SIDE PANEL (LISTE) -->
<div class="side-panel interactive" id="side-panel">
    <div class="panel-header">
        <span class="panel-title">Pays D√©couverts</span>
        <button class="close-btn" id="btn-close-list">√ó</button>
    </div>
    <div class="list-container" id="guessed-list">
        <!-- JS Generated -->
    </div>
</div>

<!-- MENU MODAL -->
<div id="start-modal" class="modal-backdrop visible interactive">
    <div class="game-card">
        <h2>Worldle Arcade</h2>
        <p class="subtitle">Explorez le monde en 3D. Trouvez les pays, g√©rez votre temps et devenez une l√©gende.</p>
        
        <div class="settings-grid">
            <div>
                <label>R√©gion</label>
                <select id="opt-region">
                    <option value="World">Monde Entier üåç</option>
                    <option value="Europe">Europe üè∞</option>
                    <option value="Asia">Asie ‚õ©Ô∏è</option>
                    <option value="Africa">Afrique ü¶Å</option>
                    <option value="Americas">Am√©riques üåé</option>
                    <option value="Oceania">Oc√©anie üèùÔ∏è</option>
                </select>
            </div>
            <div>
                <label>Mode de Jeu</label>
                <select id="opt-mode">
                    <option value="type">Saisie (Clavier) ‚å®Ô∏è</option>
                    <option value="click">Localisation (Clic) üñ±Ô∏è</option>
                </select>
            </div>
        </div>

        <button id="btn-start" class="btn-main" disabled>Chargement...</button>
    </div>
</div>

<!-- HINT MODAL -->
<div id="hint-modal" class="modal-backdrop interactive">
    <div class="game-card">
        <h2>Centre d'Indices</h2>
        <p class="subtitle">R√©v√©ler une info sur un pays <strong>non trouv√©</strong> (P√©nalit√© de temps).</p>
        
        <div class="hint-grid">
            <div class="hint-option" onclick="game.revealHint('capital')">
                <span>üèôÔ∏è Capitale</span>
                <span class="hint-cost">+20s</span>
            </div>
            <div class="hint-option" onclick="game.revealHint('flag')">
                <span>üè≥Ô∏è Drapeau</span>
                <span class="hint-cost">+20s</span>
            </div>
            <div class="hint-option" onclick="game.revealHint('both')">
                <span>‚ú® Les Deux</span>
                <span class="hint-cost">+40s</span>
            </div>
        </div>
        
        <button onclick="document.getElementById('hint-modal').classList.remove('visible')" class="btn-main btn-secondary">Annuler</button>
    </div>
</div>

<!-- REVEAL MODAL -->
<div id="hint-reveal-modal" class="modal-backdrop interactive">
    <div class="game-card">
        <h2 style="color:var(--warning); -webkit-text-fill-color: var(--warning);">Renseignement</h2>
        <p class="subtitle" style="margin-bottom:10px">Voici vos informations :</p>
        
        <div id="hint-content" style="background:rgba(255,255,255,0.05); padding:20px; border-radius:12px; border:1px solid rgba(255,255,255,0.1);">
            <!-- Content -->
        </div>
        
        <button onclick="document.getElementById('hint-reveal-modal').classList.remove('visible')" class="btn-main">Compris !</button>
    </div>
</div>

<!-- VICTORY MODAL -->
<div id="end-modal" class="modal-backdrop interactive">
    <div class="game-card">
        <h2 id="end-title">Victoire !</h2>
        <div style="font-size:4em; margin:10px 0;">üèÜ</div>
        <p id="end-msg" style="font-size:1.2em; font-weight:bold;">Tous les pays trouv√©s !</p>
        
        <div style="margin: 20px 0; background:rgba(255,255,255,0.05); padding:15px; border-radius:12px;">
            <div style="font-size:0.9em; color:#94a3b8;">Temps Final</div>
            <div id="end-time-final" style="font-size:1.8em; font-weight:900; color:var(--warning); font-family:monospace;">00:00</div>
            <div style="font-size:0.9em; color:#94a3b8; margin-top:5px;">XP Gagn√©e: <span id="end-xp" style="color:var(--success)">+0</span></div>
        </div>

        <button id="btn-share" class="btn-main" style="background:#334155; margin-bottom:10px;">Partager Score üìã</button>
        <button id="btn-replay" class="btn-main">Rejouer</button>
    </div>
</div>

<script>
/**
 * WORLDLE ARCADE 3D - FINAL PRODUCTION BUILD
 * Optimized, Cleaned, and Ready for Deployment.
 */

// --- CONFIGURATION ---
const API_GEO = 'https://cdn.jsdelivr.net/gh/johan/world.geo.json@master/countries.geo.json';
const API_META = 'https://restcountries.com/v3.1/all?fields=cca3,name,translations,capital,region,latlng,population,flags';

// --- STATE ---
const state = {
    data: [],
    activeGame: { 
        running: false, 
        region: 'World', 
        mode: 'type', 
        subset: [], 
        found: new Set(), 
        target: null, 
        timer: 0, 
        timerActive: false 
    },
    stats: { xp: 0, level: 1, combo: 1, lastGuess: 0 },
    settings: { sound: true },
    interval: null
};

// --- DOM ELEMENTS ---
const $ = (id) => document.getElementById(id);
const els = {
    loader: $('loader-overlay'),
    globe: $('globe-viz'),
    input: $('country-input'),
    score: $('score-current'),
    total: $('score-total'),
    timer: $('timer-val'),
    xpBar: $('xp-bar'),
    level: $('level-val'),
    combo: { box: $('combo-box'), val: $('combo-display') },
    prompt: { box: $('target-prompt'), name: $('target-name') },
    modals: { start: $('start-modal'), end: $('end-modal'), hint: $('hint-modal'), reveal: $('hint-reveal-modal') },
    panels: { list: $('side-panel'), listContent: $('guessed-list') },
    btns: { start: $('btn-start'), replay: $('btn-replay'), reset: $('btn-reset'), list: $('btn-toggle-list'), closeList: $('btn-close-list'), hint: $('btn-hint'), sound: $('btn-sound'), share: $('btn-share') },
    hintContent: $('hint-content')
};

let globe, audioCtx;

// --- AUDIO MANAGER ---
const AudioMgr = {
    init: () => { 
        if(!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)(); 
    },
    resume: () => {
        if(audioCtx && audioCtx.state === 'suspended') audioCtx.resume();
    },
    play: (type) => {
        if (!state.settings.sound) return;
        AudioMgr.init(); AudioMgr.resume();
        const t = audioCtx.currentTime;
        const osc = audioCtx.createOscillator();
        const gain = audioCtx.createGain();
        osc.connect(gain); gain.connect(audioCtx.destination);

        if (type === 'correct') {
            // Accord Majeur satisfaisant
            playTone(440, 'sine', 0, 0.1); playTone(554.37, 'sine', 0.05, 0.15); playTone(659.25, 'sine', 0.1, 0.2);
        } else if (type === 'wrong') {
            osc.type = 'sawtooth'; osc.frequency.setValueAtTime(150, t); osc.frequency.linearRampToValueAtTime(50, t+0.3);
            gain.gain.setValueAtTime(0.1, t); gain.gain.exponentialRampToValueAtTime(0.01, t+0.3);
            osc.start(t); osc.stop(t+0.3);
        } else if (type === 'levelup') {
            playTone(440, 'square', 0, 0.4); playTone(880, 'square', 0.1, 0.4); playTone(1760, 'square', 0.2, 0.6);
        } else if (type === 'penalty') {
            osc.type = 'triangle'; osc.frequency.setValueAtTime(200, t); osc.frequency.linearRampToValueAtTime(100, t+0.5);
            gain.gain.setValueAtTime(0.2, t); gain.gain.linearRampToValueAtTime(0, t+0.5);
            osc.start(t); osc.stop(t+0.5);
        }
    },
    toggle: () => {
        state.settings.sound = !state.settings.sound;
        els.btns.sound.innerText = state.settings.sound ? "üîä" : "üîá";
        els.btns.sound.style.opacity = state.settings.sound ? 1 : 0.5;
    }
};

function playTone(f, type, delay, dur) {
    const osc = audioCtx.createOscillator(); const g = audioCtx.createGain();
    osc.connect(g); g.connect(audioCtx.destination);
    osc.type = type; osc.frequency.value = f;
    const t = audioCtx.currentTime + delay;
    g.gain.setValueAtTime(0, t); g.gain.linearRampToValueAtTime(0.1, t+0.05); g.gain.exponentialRampToValueAtTime(0.001, t+dur);
    osc.start(t); osc.stop(t+dur);
}

// --- INITIALIZATION ---
async function initApp() {
    try {
        // Fetch Data
        const [geoRes, metaRes] = await Promise.all([
            fetch(API_GEO), fetch(API_META)
        ]);

        if(!geoRes.ok || !metaRes.ok) throw new Error("API Error");

        const geo = await geoRes.json();
        const meta = await metaRes.json();

        // Merge Data
        state.data = geo.features.map(f => {
            const m = meta.find(c => c.cca3 === f.id);
            if (!m) return null;
            return {
                id: f.id,
                geo: f,
                name: m.name.common,
                fr: m.translations.fra?.common || m.name.common,
                region: m.region,
                capital: m.capital ? m.capital[0] : 'N/A',
                coords: { lat: m.latlng[0], lng: m.latlng[1] },
                flag: m.flags.svg
            };
        }).filter(x => x);

        loadSave();
        initGlobe();
        
        // Ready
        els.loader.style.opacity = 0;
        setTimeout(() => els.loader.style.display = 'none', 500);
        els.btns.start.textContent = "Lancer l'Aventure";
        els.btns.start.disabled = false;

    } catch (e) {
        console.error(e);
        els.loader.innerHTML = "<div style='color:red; text-align:center'>Erreur de chargement.<br>Veuillez rafra√Æchir la page.</div>";
    }
}

function initGlobe() {
    globe = Globe()
        .backgroundColor('rgba(0,0,0,0)')
        .showAtmosphere(true)
        .atmosphereColor('#4cc9f0')
        .atmosphereAltitude(0.15)
        .globeImageUrl('//unpkg.com/three-globe/example/img/earth-blue-marble.jpg')
        .bumpImageUrl('//unpkg.com/three-globe/example/img/earth-topology.png')
        .polygonsData(state.data.map(c => ({ ...c.geo, data: c })))
        
        // Z-Fighting Fix & Visuals
        .polygonAltitude(0.01)
        .polygonSideColor(() => 'rgba(0,0,0,0)')
        .polygonStrokeColor(() => 'rgba(255, 255, 255, 0.2)')
        .polygonCapColor(() => 'rgba(30, 41, 59, 0.6)')
        
        .onPolygonClick(handleInput.click)
        .onPolygonHover(d => els.globe.style.cursor = d ? 'pointer' : 'grab')
        .polygonLabel(({ data }) => `
            <div style="background:rgba(15,23,42,0.9); color:white; padding:6px 10px; border-radius:6px; font-family:sans-serif; border:1px solid rgba(255,255,255,0.2); font-size:14px;">
                ${data.fr}
            </div>
        `)
        (els.globe);

    globe.controls().autoRotate = true;
    globe.controls().autoRotateSpeed = 0.5;
    globe.pointOfView({ altitude: 2.5 });
    
    // Adjust to container
    new ResizeObserver(() => {
        globe.width(els.globe.clientWidth);
        globe.height(els.globe.clientHeight);
    }).observe($('scene-container'));
}

// --- CORE GAME LOGIC ---
const game = {
    start: () => {
        const r = $('opt-region').value;
        const m = $('opt-mode').value;
        
        // Setup Game State
        state.activeGame = {
            running: true,
            region: r,
            mode: m,
            subset: r === 'World' ? state.data : state.data.filter(c => c.region === r),
            found: new Set(),
            target: null,
            timer: 0,
            timerActive: false
        };

        if(state.activeGame.subset.length === 0) {
            alert("Aucun pays dans cette r√©gion (Erreur donn√©es)");
            return;
        }

        // Reset UI
        state.stats.combo = 1;
        els.score.innerText = 0;
        els.total.innerText = state.activeGame.subset.length;
        els.timer.innerText = "00:00";
        els.timer.classList.remove('running');
        els.panels.listContent.innerHTML = '';
        els.combo.box.classList.remove('active');
        
        // Close Modals
        els.modals.start.classList.remove('visible');
        els.modals.end.classList.remove('visible');
        
        // Mode Specifics
        els.input.value = '';
        if (m === 'click') {
            $('input-container').style.display = 'none';
            els.prompt.box.classList.remove('hidden');
            game.nextTarget();
        } else {
            $('input-container').style.display = 'flex';
            els.prompt.box.classList.add('hidden');
            els.input.focus();
            globe.polygonLabel(null); // Hide labels for hard mode
        }

        globe.controls().autoRotate = false;
        
        // Focus Camera
        const first = state.activeGame.subset[0];
        globe.pointOfView({ lat: first.coords.lat, lng: first.coords.lng, altitude: 2 }, 1000);
        
        game.updateVisuals();
    },

    checkTimer: () => {
        if(!state.activeGame.timerActive) {
            state.activeGame.timerActive = true;
            els.timer.classList.add('running');
            state.interval = setInterval(() => {
                state.activeGame.timer++;
                game.renderTimer();
            }, 1000);
        }
    },

    stop: () => {
        state.activeGame.running = false;
        state.activeGame.timerActive = false;
        clearInterval(state.interval);
        els.timer.classList.remove('running');
    },

    renderTimer: () => {
        const m = Math.floor(state.activeGame.timer / 60).toString().padStart(2, '0');
        const s = (state.activeGame.timer % 60).toString().padStart(2, '0');
        els.timer.innerText = `${m}:${s}`;
    },

    penalty: (sec) => {
        game.checkTimer(); // Ensure timer starts if penalty taken before first guess
        state.activeGame.timer += sec;
        game.renderTimer();
        AudioMgr.play('penalty');
        els.timer.classList.add('penalty-flash');
        setTimeout(() => els.timer.classList.remove('penalty-flash'), 500);
    },

    success: (country) => {
        game.checkTimer(); // Start timer if first guess
        state.activeGame.found.add(country.id);

        // Combo Logic
        const now = Date.now();
        if (now - state.stats.lastGuess < 6000) state.stats.combo++;
        else state.stats.combo = 1;
        state.stats.lastGuess = now;

        // Rewards
        AudioMgr.play('correct');
        confetti({ particleCount: 80, spread: 60, origin: { y: 0.6 }, colors: ['#4cc9f0', '#f72585'] });
        ui.floatText(`+${10 * state.stats.combo} XP`, window.innerWidth/2, window.innerHeight/2);
        ui.gainXP(10 * state.stats.combo);

        // Updates
        els.score.innerText = state.activeGame.found.size;
        ui.updateCombo();
        game.updateVisuals();
        ui.addToList(country);

        // Camera
        globe.pointOfView({ lat: country.coords.lat, lng: country.coords.lng, altitude: 1.5 }, 1000);

        // Win Condition
        if (state.activeGame.found.size === state.activeGame.subset.length) game.win();
    },

    fail: () => {
        state.stats.combo = 1;
        ui.updateCombo();
        AudioMgr.play('wrong');
        document.body.classList.add('shake');
        setTimeout(() => document.body.classList.remove('shake'), 400);
    },

    nextTarget: () => {
        const remaining = state.activeGame.subset.filter(c => !state.activeGame.found.has(c.id));
        if(remaining.length === 0) return game.win();
        state.activeGame.target = remaining[Math.floor(Math.random() * remaining.length)];
        els.prompt.name.innerText = state.activeGame.target.fr;
    },

    updateVisuals: () => {
        globe.polygonCapColor(({ data }) => {
            if (state.activeGame.found.has(data.id)) return '#4cc9f0'; // Neon Blue Found
            if (!state.activeGame.running) return 'rgba(30, 41, 59, 0.6)';
            
            // Visually distinguish active region vs rest of world
            if (state.activeGame.subset.find(c => c.id === data.id)) return 'rgba(255, 255, 255, 0.1)';
            return 'rgba(30, 41, 59, 0.6)';
        });
        
        const d = globe.polygonsData();
        globe.polygonsData([...d]); // Force refresh
    },

    revealHint: (type) => {
        if (!state.activeGame.running) return;
        
        const remaining = state.activeGame.subset.filter(c => !state.activeGame.found.has(c.id));
        if (remaining.length === 0) return;

        // Pick target: either current click target or random one
        const target = state.activeGame.mode === 'click' 
            ? state.activeGame.target 
            : remaining[Math.floor(Math.random() * remaining.length)];

        let cost = 20;
        let html = '';

        if (type === 'capital') {
            html = `<strong>üèôÔ∏è Capitale :</strong> <span style="color:var(--primary); font-size:1.3em;">${target.capital}</span>`;
        } else if (type === 'flag') {
            html = `<strong>üè≥Ô∏è Drapeau :</strong><br><img src="${target.flag}" class="revealed-flag">`;
        } else {
            cost = 40;
            html = `<strong>üèôÔ∏è Capitale :</strong> ${target.capital}<br><strong>üè≥Ô∏è Drapeau :</strong><br><img src="${target.flag}" class="revealed-flag">`;
        }

        game.penalty(cost);
        
        els.modals.hint.classList.remove('visible');
        els.hintContent.innerHTML = html;
        els.modals.reveal.classList.add('visible');
        
        // Help player locate the area
        globe.pointOfView({ lat: target.coords.lat, lng: target.coords.lng, altitude: 2.2 }, 1200);
    },

    win: () => {
        game.stop();
        els.modals.end.classList.add('visible');
        $('end-xp').innerText = `+${state.activeGame.found.size * 10}`;
        $('end-time-final').innerText = els.timer.innerText;
        globe.controls().autoRotate = true;
    }
};

// --- INPUT HANDLING ---
const handleInput = {
    type: () => {
        if (!state.activeGame.running || state.activeGame.mode !== 'type') return;
        const val = normalize(els.input.value);
        const match = state.activeGame.subset.find(c => 
            !state.activeGame.found.has(c.id) && normalize(c.fr) === val
        );

        if (match) {
            game.success(match);
            els.input.value = '';
        }
    },
    click: (polygon) => {
        if (!state.activeGame.running) return;
        const c = polygon.data;
        if (state.activeGame.mode === 'click') {
            if (c.id === state.activeGame.target.id) {
                game.success(c);
                game.nextTarget();
            } else {
                game.fail();
            }
        }
    }
};

// --- UI HELPERS ---
const ui = {
    gainXP: (amount) => {
        state.stats.xp += amount;
        const needed = state.stats.level * 100;
        if(state.stats.xp >= needed) {
            state.stats.level++;
            state.stats.xp -= needed;
            AudioMgr.play('levelup');
            ui.floatText("NIVEAU SUP√âRIEUR !", window.innerWidth/2, window.innerHeight/3, 'var(--accent)');
        }
        saveGame();
        ui.renderStats();
    },
    renderStats: () => {
        els.level.innerText = state.stats.level;
        els.xpBar.style.width = `${(state.stats.xp / (state.stats.level * 100)) * 100}%`;
    },
    updateCombo: () => {
        if (state.stats.combo > 1) {
            els.combo.box.classList.add('active');
            els.combo.val.innerText = `x${state.stats.combo}`;
            els.combo.val.style.transform = 'scale(1.5)';
            setTimeout(() => els.combo.val.style.transform = 'scale(1)', 200);
        } else {
            els.combo.box.classList.remove('active');
        }
    },
    addToList: (c) => {
        const div = document.createElement('div'); div.className = 'list-item';
        div.innerHTML = `<img src="${c.flag}" class="list-flag" loading="lazy"><span class="list-name">${c.fr}</span>`;
        div.onclick = () => { 
            globe.pointOfView({ lat: c.coords.lat, lng: c.coords.lng, altitude: 1.2 }, 1000); 
            if (window.innerWidth < 600) els.panels.list.classList.remove('open');
        };
        els.panels.listContent.prepend(div);
    },
    floatText: (text, x, y, color) => {
        const el = document.createElement('div'); el.className = 'floater'; 
        el.innerText = text; el.style.left = `${x}px`; el.style.top = `${y}px`;
        if(color) el.style.color = color;
        document.body.appendChild(el);
        setTimeout(() => el.remove(), 1200);
    }
};

// --- UTILS ---
function normalize(s) { return s.normalize("NFD").replace(/[\u0300-\u036f]/g, "").toLowerCase().replace(/-/g, " ").trim(); }
function saveGame() { localStorage.setItem('wa_xp', state.stats.xp); localStorage.setItem('wa_lvl', state.stats.level); }
function loadSave() { 
    state.stats.xp = parseInt(localStorage.getItem('wa_xp')) || 0; 
    state.stats.level = parseInt(localStorage.getItem('wa_lvl')) || 1; 
    ui.renderStats(); 
}

// --- EVENT LISTENERS ---
// Buttons
els.btns.start.onclick = game.start;
els.btns.replay.onclick = () => { els.modals.end.classList.remove('visible'); els.modals.start.classList.add('visible'); };
els.btns.reset.onclick = () => { if(confirm("Quitter la partie en cours ?")) { game.stop(); els.modals.start.classList.add('visible'); globe.controls().autoRotate = true; } };
els.btns.list.onclick = () => els.panels.list.classList.add('open');
els.btns.closeList.onclick = () => els.panels.list.classList.remove('open');
els.btns.hint.onclick = () => { if(state.activeGame.running) els.modals.hint.classList.add('visible'); };
els.btns.sound.onclick = AudioMgr.toggle;
els.btns.share.onclick = () => {
    const txt = `üåç Worldle Arcade 3D\nüèÜ Niveau ${state.stats.level}\n‚è±Ô∏è ${els.timer.innerText}\n‚úÖ ${state.activeGame.found.size} pays trouv√©s !`;
    navigator.clipboard.writeText(txt).then(() => alert("Score copi√© !"));
};

// Input
els.input.oninput = handleInput.type;

// Mobile Keyboard Handling
if (/iPad|iPhone|iPod/.test(navigator.userAgent)) {
    els.input.addEventListener('focus', () => { 
        document.body.classList.add('keyboard-open'); 
        globe.pointOfView({ lat: globe.pointOfView().lat + 25, altitude: globe.pointOfView().altitude }, 500);
    });
    els.input.addEventListener('blur', () => document.body.classList.remove('keyboard-open'));
}

// Start App
initApp();

</script>
</body>
</html>
